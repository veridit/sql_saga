\i sql/include/test_setup.sql
--
-- test_setup.sql
--
-- Common setup for regression tests that need to be self-contained.
-- This script creates the extension, a user role, and grants permissions.
--
SET datestyle = 'ISO, YMD';
CREATE EXTENSION IF NOT EXISTS btree_gist;
CREATE EXTENSION IF NOT EXISTS sql_saga CASCADE;
DO $$
BEGIN
    CREATE ROLE sql_saga_unprivileged_user;
EXCEPTION WHEN duplicate_object THEN
END
$$;
GRANT USAGE ON SCHEMA sql_saga TO sql_saga_unprivileged_user;
GRANT SELECT ON ALL TABLES IN SCHEMA sql_saga TO sql_saga_unprivileged_user;
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA sql_saga TO sql_saga_unprivileged_user;
/*
 * Allow the unprivileged user to create tables in the public schema.
 * This is required for tests that create their own tables.
 * PG 15+ restricts this by default.
 */
GRANT CREATE ON SCHEMA public TO PUBLIC;
BEGIN;
/* Run tests as unprivileged user */
SET ROLE TO sql_saga_unprivileged_user;
/* Basic period definitions with dates */
CREATE TABLE basic (val text, valid daterange, valid_from date, valid_until date);
TABLE sql_saga.era;
 table_schema | table_name | era_name | range_column_name | valid_from_column_name | valid_until_column_name | range_type | multirange_type | range_subtype | range_subtype_category | bounds_check_constraint | boundary_check_constraint | valid_to_column_name | trigger_applies_defaults | sync_temporal_trg_name | sync_temporal_trg_function_name | audit_schema_name | audit_table_name | ephemeral_columns 
--------------+------------+----------+-------------------+------------------------+-------------------------+------------+-----------------+---------------+------------------------+-------------------------+---------------------------+----------------------+--------------------------+------------------------+---------------------------------+-------------------+------------------+-------------------
(0 rows)

SELECT sql_saga.add_era('basic', 'valid', 'bp', valid_from_column_name := 'valid_from', valid_until_column_name := 'valid_until', add_defaults := false);
NOTICE:  sql_saga: Created trigger "basic_synchronize_temporal_columns_trigger" on table basic to synchronize columns: valid_from, valid_until
NOTICE:  sql_saga: Created GIST index "basic_valid_gist_idx" on column public.basic.valid for temporal_merge performance
 add_era 
---------
 t
(1 row)

TABLE sql_saga.era;
 table_schema | table_name | era_name | range_column_name | valid_from_column_name | valid_until_column_name | range_type | multirange_type | range_subtype | range_subtype_category | bounds_check_constraint | boundary_check_constraint | valid_to_column_name | trigger_applies_defaults |   sync_temporal_trg_name   | sync_temporal_trg_function_name | audit_schema_name | audit_table_name | ephemeral_columns 
--------------+------------+----------+-------------------+------------------------+-------------------------+------------+-----------------+---------------+------------------------+-------------------------+---------------------------+----------------------+--------------------------+----------------------------+---------------------------------+-------------------+------------------+-------------------
 public       | basic      | bp       | valid             | valid_from             | valid_until             | daterange  | datemultirange  | date          | D                      | basic_bp_check          | basic_check               |                      | f                        | basic_bp_sync_temporal_trg | public_basic_bp_template_sync   |                   |                  | 
(1 row)

SELECT sql_saga.drop_era('basic', 'bp');
 drop_era 
----------
 t
(1 row)

TABLE sql_saga.era;
 table_schema | table_name | era_name | range_column_name | valid_from_column_name | valid_until_column_name | range_type | multirange_type | range_subtype | range_subtype_category | bounds_check_constraint | boundary_check_constraint | valid_to_column_name | trigger_applies_defaults | sync_temporal_trg_name | sync_temporal_trg_function_name | audit_schema_name | audit_table_name | ephemeral_columns 
--------------+------------+----------+-------------------+------------------------+-------------------------+------------+-----------------+---------------+------------------------+-------------------------+---------------------------+----------------------+--------------------------+------------------------+---------------------------------+-------------------+------------------+-------------------
(0 rows)

SELECT sql_saga.add_era('basic', 'valid', 'bp', valid_from_column_name := 'valid_from', valid_until_column_name := 'valid_until', bounds_check_constraint => 'c', add_defaults => false);
NOTICE:  sql_saga: Created trigger "basic_synchronize_temporal_columns_trigger" on table basic to synchronize columns: valid_from, valid_until
 add_era 
---------
 t
(1 row)

TABLE sql_saga.era;
 table_schema | table_name | era_name | range_column_name | valid_from_column_name | valid_until_column_name | range_type | multirange_type | range_subtype | range_subtype_category | bounds_check_constraint | boundary_check_constraint | valid_to_column_name | trigger_applies_defaults |   sync_temporal_trg_name   | sync_temporal_trg_function_name | audit_schema_name | audit_table_name | ephemeral_columns 
--------------+------------+----------+-------------------+------------------------+-------------------------+------------+-----------------+---------------+------------------------+-------------------------+---------------------------+----------------------+--------------------------+----------------------------+---------------------------------+-------------------+------------------+-------------------
 public       | basic      | bp       | valid             | valid_from             | valid_until             | daterange  | datemultirange  | date          | D                      | c                       | basic_check               |                      | f                        | basic_bp_sync_temporal_trg | public_basic_bp_template_sync   |                   |                  | 
(1 row)

/* Test constraints */
SAVEPOINT pristine;
INSERT INTO basic (val, valid_from, valid_until) VALUES ('x', null, null); --fail
ERROR:  The temporal period could not be determined. At least one of "valid" or the pair "valid_from"/"valid_until" must be provided.
CONTEXT:  PL/pgSQL function sql_saga.public_basic_bp_template_sync() line 114 at RAISE
ROLLBACK TO SAVEPOINT pristine;
INSERT INTO basic (val, valid_from, valid_until) VALUES ('x', '3000-01-01', null); --fail
ERROR:  The temporal period could not be determined. At least one of "valid" or the pair "valid_from"/"valid_until" must be provided.
CONTEXT:  PL/pgSQL function sql_saga.public_basic_bp_template_sync() line 114 at RAISE
ROLLBACK TO SAVEPOINT pristine;
INSERT INTO basic (val, valid_from, valid_until) VALUES ('x', null, '1000-01-01'); --fail
ERROR:  The temporal period could not be determined. At least one of "valid" or the pair "valid_from"/"valid_until" must be provided.
CONTEXT:  PL/pgSQL function sql_saga.public_basic_bp_template_sync() line 114 at RAISE
ROLLBACK TO SAVEPOINT pristine;
INSERT INTO basic (val, valid_from, valid_until) VALUES ('x', '3000-01-01', '1000-01-01'); --fail
ERROR:  null value in column "valid" of relation "basic" violates not-null constraint
DETAIL:  Failing row contains (x, null, 3000-01-01, 1000-01-01).
ROLLBACK TO SAVEPOINT pristine;
INSERT INTO basic (val, valid_from, valid_until) VALUES ('x', '1000-01-01', '3000-01-01'); --success
TABLE basic;
 val |          valid          | valid_from | valid_until 
-----+-------------------------+------------+-------------
 x   | [1000-01-01,3000-01-01) | 1000-01-01 | 3000-01-01
(1 row)

/* Test dropping the whole thing */
SELECT sql_saga.drop_era('basic', 'bp');
 drop_era 
----------
 t
(1 row)

DROP TABLE basic;
ROLLBACK;
\i sql/include/test_teardown.sql
--
-- test_teardown.sql
--
-- Common teardown for regression tests. This script drops the unprivileged
-- user role created by test_setup.sql.
--
-- It is important to reset the role first, in case a test fails and
-- leaves the session role set to the user that is about to be dropped.
RESET ROLE;
-- Drop the extensions to ensure a clean state for the next test.
-- Use CASCADE to remove any dependent objects created by sql_saga.
DROP EXTENSION IF EXISTS sql_saga CASCADE;
DROP EXTENSION IF EXISTS btree_gist CASCADE;
-- Revoke any privileges held by the test user and drop any objects they own.
-- This is necessary before the role can be dropped.
DROP OWNED BY sql_saga_unprivileged_user;
DROP ROLE IF EXISTS sql_saga_unprivileged_user;
