\i sql/include/test_setup.sql
--
-- test_setup.sql
--
-- Common setup for regression tests that need to be self-contained.
-- This script creates the extension, a user role, and grants permissions.
--
SET datestyle = 'ISO, YMD';
CREATE EXTENSION IF NOT EXISTS btree_gist;
CREATE EXTENSION IF NOT EXISTS sql_saga CASCADE;
DO $$
BEGIN
    CREATE ROLE sql_saga_unprivileged_user;
EXCEPTION WHEN duplicate_object THEN
END
$$;
GRANT USAGE ON SCHEMA sql_saga TO sql_saga_unprivileged_user;
GRANT SELECT ON ALL TABLES IN SCHEMA sql_saga TO sql_saga_unprivileged_user;
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA sql_saga TO sql_saga_unprivileged_user;
/*
 * Allow the unprivileged user to create tables in the public schema.
 * This is required for tests that create their own tables.
 * PG 15+ restricts this by default.
 */
GRANT CREATE ON SCHEMA public TO PUBLIC;
CREATE TABLE system_versioning_test (
    id int PRIMARY KEY,
    name text
);
-- Add system versioning
SELECT sql_saga.add_system_versioning('system_versioning_test');
 add_system_versioning 
-----------------------
 
(1 row)

-- Check that columns and triggers were added
\d system_versioning_test
                                              Table "public.system_versioning_test"
       Column       |   Type    | Collation | Nullable |                                 Default                                  
--------------------+-----------+-----------+----------+--------------------------------------------------------------------------
 id                 | integer   |           | not null | 
 name               | text      |           |          | 
 system_valid_range | tstzrange |           | not null | tstzrange(transaction_timestamp(), 'infinity'::timestamp with time zone)
Indexes:
    "system_versioning_test_pkey" PRIMARY KEY, btree (id)
Check constraints:
    "system_versioning_test_system_valid_range_infinity_check" CHECK (upper(system_valid_range) = 'infinity'::timestamp with time zone)
Triggers:
    system_versioning_test_system_time_generated_always BEFORE INSERT OR UPDATE ON system_versioning_test FOR EACH ROW EXECUTE FUNCTION sql_saga.generated_always_as_row_start_end('system_valid_range')
    system_versioning_test_system_time_write_history AFTER DELETE OR UPDATE ON system_versioning_test FOR EACH ROW EXECUTE FUNCTION sql_saga.write_history('system_valid_range')
    system_versioning_test_truncate AFTER TRUNCATE ON system_versioning_test FOR EACH STATEMENT EXECUTE FUNCTION sql_saga.truncate_system_versioning()

-- Check metadata tables
SELECT table_schema, table_name, era_name, range_column_name, valid_from_column_name, valid_until_column_name FROM sql_saga.era WHERE table_name = 'system_versioning_test';
 table_schema |       table_name       |  era_name   | range_column_name  | valid_from_column_name | valid_until_column_name 
--------------+------------------------+-------------+--------------------+------------------------+-------------------------
 public       | system_versioning_test | system_time | system_valid_range |                        | 
(1 row)

SELECT table_schema, table_name, era_name, infinity_check_constraint, generated_always_trigger, write_history_trigger, truncate_trigger FROM sql_saga.system_time_era WHERE table_name = 'system_versioning_test';
 table_schema |       table_name       |  era_name   |                infinity_check_constraint                 |              generated_always_trigger               |              write_history_trigger               |        truncate_trigger         
--------------+------------------------+-------------+----------------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+---------------------------------
 public       | system_versioning_test | system_time | system_versioning_test_system_valid_range_infinity_check | system_versioning_test_system_time_generated_always | system_versioning_test_system_time_write_history | system_versioning_test_truncate
(1 row)

SELECT table_schema, table_name, era_name, history_table_name, view_table_name FROM sql_saga.system_versioning WHERE table_name = 'system_versioning_test';
 table_schema |       table_name       |  era_name   |       history_table_name       |           view_table_name           
--------------+------------------------+-------------+--------------------------------+-------------------------------------
 public       | system_versioning_test | system_time | system_versioning_test_history | system_versioning_test_with_history
(1 row)

-- Check history table and view
\d system_versioning_test_history
          Table "public.system_versioning_test_history"
       Column       |   Type    | Collation | Nullable | Default 
--------------------+-----------+-----------+----------+---------
 id                 | integer   |           | not null | 
 name               | text      |           |          | 
 system_valid_range | tstzrange |           | not null | 

\d system_versioning_test_with_history
        View "public.system_versioning_test_with_history"
       Column       |   Type    | Collation | Nullable | Default 
--------------------+-----------+-----------+----------+---------
 id                 | integer   |           |          | 
 name               | text      |           |          | 
 system_valid_range | tstzrange |           |          | 

-- Drop system versioning
SELECT sql_saga.drop_system_versioning('system_versioning_test');
 drop_system_versioning 
------------------------
 t
(1 row)

-- Check that objects are gone
\d system_versioning_test
       Table "public.system_versioning_test"
 Column |  Type   | Collation | Nullable | Default 
--------+---------+-----------+----------+---------
 id     | integer |           | not null | 
 name   | text    |           |          | 
Indexes:
    "system_versioning_test_pkey" PRIMARY KEY, btree (id)

\d system_versioning_test_history
\d system_versioning_test_with_history
-- Check that metadata is gone
SELECT table_schema, table_name, era_name FROM sql_saga.era WHERE table_name = 'system_versioning_test';
 table_schema | table_name | era_name 
--------------+------------+----------
(0 rows)

SELECT table_schema, table_name, era_name FROM sql_saga.system_time_era WHERE table_name = 'system_versioning_test';
 table_schema | table_name | era_name 
--------------+------------+----------
(0 rows)

SELECT table_schema, table_name, era_name FROM sql_saga.system_versioning WHERE table_name = 'system_versioning_test';
 table_schema | table_name | era_name 
--------------+------------+----------
(0 rows)

\echo '\n--- Test TRUNCATE propagation to history ---'

--- Test TRUNCATE propagation to history ---
CREATE TABLE sv_truncate_test (
    id serial PRIMARY KEY,
    data text
);
SELECT sql_saga.add_system_versioning('sv_truncate_test');
 add_system_versioning 
-----------------------
 
(1 row)

-- Insert some data
INSERT INTO sv_truncate_test (data) VALUES ('row1'), ('row2'), ('row3');
-- Update to create history
UPDATE sv_truncate_test SET data = data || '_updated';
\echo '--- Before TRUNCATE: base table ---'
--- Before TRUNCATE: base table ---
SELECT COUNT(*) AS base_count FROM sv_truncate_test;
 base_count 
------------
          3
(1 row)

\echo '--- Before TRUNCATE: history table ---'
--- Before TRUNCATE: history table ---
SELECT COUNT(*) AS history_count FROM sv_truncate_test_history;
 history_count 
---------------
             3
(1 row)

-- TRUNCATE should propagate to history
TRUNCATE sv_truncate_test;
\echo '--- After TRUNCATE: base table ---'
--- After TRUNCATE: base table ---
SELECT COUNT(*) AS base_count FROM sv_truncate_test;
 base_count 
------------
          0
(1 row)

\echo '--- After TRUNCATE: history table (should also be empty) ---'
--- After TRUNCATE: history table (should also be empty) ---
SELECT COUNT(*) AS history_count FROM sv_truncate_test_history;
 history_count 
---------------
             0
(1 row)

-- Cleanup
SELECT sql_saga.drop_system_versioning('sv_truncate_test');
 drop_system_versioning 
------------------------
 t
(1 row)

DROP TABLE sv_truncate_test;
\echo '\n--- Test cross-schema system versioning ---'

--- Test cross-schema system versioning ---
-- Create a separate schema
CREATE SCHEMA sv_test_schema;
CREATE TABLE sv_test_schema.versioned_table (
    id serial PRIMARY KEY,
    name text
);
-- Add system versioning to table in non-public schema
SELECT sql_saga.add_system_versioning('sv_test_schema.versioned_table');
 add_system_versioning 
-----------------------
 
(1 row)

-- Verify metadata shows correct schema
\echo '--- Metadata for cross-schema table ---'
--- Metadata for cross-schema table ---
SELECT table_schema, table_name, history_schema_name, history_table_name 
FROM sql_saga.system_versioning 
WHERE table_name = 'versioned_table';
  table_schema  |   table_name    | history_schema_name |   history_table_name    
----------------+-----------------+---------------------+-------------------------
 sv_test_schema | versioned_table | sv_test_schema      | versioned_table_history
(1 row)

-- Verify history table created in same schema
\echo '--- History table exists in sv_test_schema ---'
--- History table exists in sv_test_schema ---
SELECT schemaname, tablename 
FROM pg_tables 
WHERE tablename = 'versioned_table_history' AND schemaname = 'sv_test_schema';
   schemaname   |        tablename        
----------------+-------------------------
 sv_test_schema | versioned_table_history
(1 row)

-- Insert and update to create history
INSERT INTO sv_test_schema.versioned_table (name) VALUES ('test');
UPDATE sv_test_schema.versioned_table SET name = 'test_updated';
\echo '--- History created in cross-schema table ---'
--- History created in cross-schema table ---
SELECT COUNT(*) AS history_count FROM sv_test_schema.versioned_table_history;
 history_count 
---------------
             1
(1 row)

-- Cleanup
SELECT sql_saga.drop_system_versioning('sv_test_schema.versioned_table');
 drop_system_versioning 
------------------------
 t
(1 row)

DROP TABLE sv_test_schema.versioned_table;
DROP SCHEMA sv_test_schema;
\echo '\n--- Error case tests ---'

--- Error case tests ---
-- Test: Cannot add system versioning to a partitioned table
CREATE TABLE sv_partitioned (
    id int,
    created_at date
) PARTITION BY RANGE (created_at);
\echo '--- Attempting system versioning on partitioned table (should fail) ---'
--- Attempting system versioning on partitioned table (should fail) ---
DO $$
BEGIN
    PERFORM sql_saga.add_system_versioning('sv_partitioned');
    RAISE EXCEPTION 'Should have failed for partitioned table';
EXCEPTION WHEN others THEN
    RAISE NOTICE 'Correctly rejected: %', SQLERRM;
END;
$$;
NOTICE:  Correctly rejected: partitioned tables are not supported yet
DROP TABLE sv_partitioned;
-- Test: Cannot add system versioning to a view
CREATE TABLE sv_base_for_view (id int PRIMARY KEY, data text);
CREATE VIEW sv_view AS SELECT * FROM sv_base_for_view;
\echo '--- Attempting system versioning on view (should fail) ---'
--- Attempting system versioning on view (should fail) ---
DO $$
BEGIN
    PERFORM sql_saga.add_system_versioning('sv_view');
    RAISE EXCEPTION 'Should have failed for view';
EXCEPTION WHEN others THEN
    RAISE NOTICE 'Correctly rejected: %', SQLERRM;
END;
$$;
NOTICE:  Correctly rejected: relation sv_view is not a table
DROP VIEW sv_view;
DROP TABLE sv_base_for_view;
-- Test: Cannot drop system_time era directly (must use drop_system_versioning)
CREATE TABLE sv_drop_era_test (id int PRIMARY KEY, data text);
SELECT sql_saga.add_system_versioning('sv_drop_era_test');
 add_system_versioning 
-----------------------
 
(1 row)

\echo '--- Attempting to drop system_time era directly (should fail) ---'
--- Attempting to drop system_time era directly (should fail) ---
DO $$
BEGIN
    PERFORM sql_saga.drop_era('sv_drop_era_test', 'system_time');
    RAISE EXCEPTION 'Should have failed - must use drop_system_versioning()';
EXCEPTION WHEN others THEN
    RAISE NOTICE 'Correctly rejected: %', SQLERRM;
END;
$$;
NOTICE:  Correctly rejected: era system_time has SYSTEM VERSIONING, use drop_system_versioning() instead
-- Proper cleanup
SELECT sql_saga.drop_system_versioning('sv_drop_era_test');
 drop_system_versioning 
------------------------
 t
(1 row)

DROP TABLE sv_drop_era_test;
\i sql/include/test_teardown.sql
--
-- test_teardown.sql
--
-- Common teardown for regression tests. This script drops the unprivileged
-- user role created by test_setup.sql.
--
-- It is important to reset the role first, in case a test fails and
-- leaves the session role set to the user that is about to be dropped.
RESET ROLE;
-- Drop the extensions to ensure a clean state for the next test.
-- Use CASCADE to remove any dependent objects created by sql_saga.
DROP EXTENSION IF EXISTS sql_saga CASCADE;
DROP EXTENSION IF EXISTS btree_gist CASCADE;
-- Revoke any privileges held by the test user and drop any objects they own.
-- This is necessary before the role can be dropped.
DROP OWNED BY sql_saga_unprivileged_user;
DROP ROLE IF EXISTS sql_saga_unprivileged_user;
