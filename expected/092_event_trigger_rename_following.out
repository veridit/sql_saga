\i sql/include/test_setup.sql
--
-- test_setup.sql
--
-- Common setup for regression tests that need to be self-contained.
-- This script creates the extension, a user role, and grants permissions.
--
SET datestyle = 'ISO, YMD';
CREATE EXTENSION IF NOT EXISTS btree_gist;
CREATE EXTENSION IF NOT EXISTS sql_saga CASCADE;
DO $$
BEGIN
    CREATE ROLE sql_saga_unprivileged_user;
EXCEPTION WHEN duplicate_object THEN
END
$$;
GRANT USAGE ON SCHEMA sql_saga TO sql_saga_unprivileged_user;
GRANT SELECT ON ALL TABLES IN SCHEMA sql_saga TO sql_saga_unprivileged_user;
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA sql_saga TO sql_saga_unprivileged_user;
/*
 * Allow the unprivileged user to create tables in the public schema.
 * This is required for tests that create their own tables.
 * PG 15+ restricts this by default.
 */
GRANT CREATE ON SCHEMA public TO PUBLIC;
BEGIN;
/* Run tests as unprivileged user */
SET ROLE TO sql_saga_unprivileged_user;
/* DDL on unrelated tables should not be affected */
CREATE TABLE unrelated(a int);
ALTER TABLE unrelated RENAME a TO b;
DROP TABLE unrelated;
/*
 * If anything we store as "name" is renamed, we need to update our catalogs or
 * throw an error.
 */
/* era */
CREATE TABLE rename_test(col1 text, col2 bigint, col3 time, valid_range int4range NOT NULL, s integer, e integer);
SELECT sql_saga.add_era('rename_test', 'valid_range', 'p', valid_from_column_name => 's', valid_until_column_name => 'e');
NOTICE:  sql_saga: Created trigger "rename_test_synchronize_temporal_columns_trigger" on table rename_test to synchronize columns: s, e
NOTICE:  sql_saga: Created GIST index "rename_test_valid_range_gist_idx" on column public.rename_test.valid_range for temporal_merge performance
 add_era 
---------
 t
(1 row)

TABLE sql_saga.era;
 table_schema | table_name  | era_name | range_column_name | valid_from_column_name | valid_until_column_name | range_type | multirange_type | range_subtype | range_subtype_category | bounds_check_constraint | boundary_check_constraint | valid_to_column_name | trigger_applies_defaults |     sync_temporal_trg_name      |  sync_temporal_trg_function_name   | audit_schema_name | audit_table_name | ephemeral_columns 
--------------+-------------+----------+-------------------+------------------------+-------------------------+------------+-----------------+---------------+------------------------+-------------------------+---------------------------+----------------------+--------------------------+---------------------------------+------------------------------------+-------------------+------------------+-------------------
 public       | rename_test | p        | valid_range       | s                      | e                       | int4range  | int4multirange  | integer       | N                      | rename_test_p_check     | rename_test_check         |                      | t                        | rename_test_p_sync_temporal_trg | public_rename_test_p_template_sync |                   |                  | 
(1 row)

ALTER TABLE rename_test RENAME s TO start;
ALTER TABLE rename_test RENAME e TO "end";
TABLE sql_saga.era;
 table_schema | table_name  | era_name | range_column_name | valid_from_column_name | valid_until_column_name | range_type | multirange_type | range_subtype | range_subtype_category | bounds_check_constraint | boundary_check_constraint | valid_to_column_name | trigger_applies_defaults |     sync_temporal_trg_name      |  sync_temporal_trg_function_name   | audit_schema_name | audit_table_name | ephemeral_columns 
--------------+-------------+----------+-------------------+------------------------+-------------------------+------------+-----------------+---------------+------------------------+-------------------------+---------------------------+----------------------+--------------------------+---------------------------------+------------------------------------+-------------------+------------------+-------------------
 public       | rename_test | p        | valid_range       | start                  | end                     | int4range  | int4multirange  | integer       | N                      | rename_test_p_check     | rename_test_check         |                      | t                        | rename_test_p_sync_temporal_trg | public_rename_test_p_template_sync |                   |                  | 
(1 row)

ALTER TABLE rename_test RENAME start TO "s < e";
TABLE sql_saga.era;
 table_schema | table_name  | era_name | range_column_name | valid_from_column_name | valid_until_column_name | range_type | multirange_type | range_subtype | range_subtype_category | bounds_check_constraint | boundary_check_constraint | valid_to_column_name | trigger_applies_defaults |     sync_temporal_trg_name      |  sync_temporal_trg_function_name   | audit_schema_name | audit_table_name | ephemeral_columns 
--------------+-------------+----------+-------------------+------------------------+-------------------------+------------+-----------------+---------------+------------------------+-------------------------+---------------------------+----------------------+--------------------------+---------------------------------+------------------------------------+-------------------+------------------+-------------------
 public       | rename_test | p        | valid_range       | s < e                  | end                     | int4range  | int4multirange  | integer       | N                      | rename_test_p_check     | rename_test_check         |                      | t                        | rename_test_p_sync_temporal_trg | public_rename_test_p_template_sync |                   |                  | 
(1 row)

ALTER TABLE rename_test RENAME "end" TO "embedded "" symbols";
TABLE sql_saga.era;
 table_schema | table_name  | era_name | range_column_name | valid_from_column_name | valid_until_column_name | range_type | multirange_type | range_subtype | range_subtype_category | bounds_check_constraint | boundary_check_constraint | valid_to_column_name | trigger_applies_defaults |     sync_temporal_trg_name      |  sync_temporal_trg_function_name   | audit_schema_name | audit_table_name | ephemeral_columns 
--------------+-------------+----------+-------------------+------------------------+-------------------------+------------+-----------------+---------------+------------------------+-------------------------+---------------------------+----------------------+--------------------------+---------------------------------+------------------------------------+-------------------+------------------+-------------------
 public       | rename_test | p        | valid_range       | s < e                  | embedded " symbols      | int4range  | int4multirange  | integer       | N                      | rename_test_p_check     | rename_test_check         |                      | t                        | rename_test_p_sync_temporal_trg | public_rename_test_p_template_sync |                   |                  | 
(1 row)

ALTER TABLE rename_test RENAME CONSTRAINT rename_test_p_check TO start_before_end;
TABLE sql_saga.era;
 table_schema | table_name  | era_name | range_column_name | valid_from_column_name | valid_until_column_name | range_type | multirange_type | range_subtype | range_subtype_category | bounds_check_constraint | boundary_check_constraint | valid_to_column_name | trigger_applies_defaults |     sync_temporal_trg_name      |  sync_temporal_trg_function_name   | audit_schema_name | audit_table_name | ephemeral_columns 
--------------+-------------+----------+-------------------+------------------------+-------------------------+------------+-----------------+---------------+------------------------+-------------------------+---------------------------+----------------------+--------------------------+---------------------------------+------------------------------------+-------------------+------------------+-------------------
 public       | rename_test | p        | valid_range       | s < e                  | embedded " symbols      | int4range  | int4multirange  | integer       | N                      | start_before_end        | rename_test_check         |                      | t                        | rename_test_p_sync_temporal_trg | public_rename_test_p_template_sync |                   |                  | 
(1 row)

/* api */
ALTER TABLE rename_test ADD COLUMN id integer PRIMARY KEY;
SELECT sql_saga.add_for_portion_of_view('rename_test', 'p');
 add_for_portion_of_view 
-------------------------
 t
(1 row)

TABLE sql_saga.updatable_view;
 view_schema |           view_name           |   view_type    | table_schema | table_name  | era_name |   trigger_name   | current_func | generated_columns | ephemeral_columns 
-------------+-------------------------------+----------------+--------------+-------------+----------+------------------+--------------+-------------------+-------------------
 public      | rename_test__for_portion_of_p | for_portion_of | public       | rename_test | p        | for_portion_of_p |              | {}                | 
(1 row)

ALTER TRIGGER for_portion_of_p ON rename_test__for_portion_of_p RENAME TO portion_trigger;
TABLE sql_saga.updatable_view;
 view_schema |           view_name           |   view_type    | table_schema | table_name  | era_name |  trigger_name   | current_func | generated_columns | ephemeral_columns 
-------------+-------------------------------+----------------+--------------+-------------+----------+-----------------+--------------+-------------------+-------------------
 public      | rename_test__for_portion_of_p | for_portion_of | public       | rename_test | p        | portion_trigger |              | {}                | 
(1 row)

SELECT sql_saga.drop_for_portion_of_view('rename_test', 'p');
 drop_for_portion_of_view 
--------------------------
 t
(1 row)

ALTER TABLE rename_test DROP COLUMN id;
/* unique_keys */
SELECT sql_saga.add_unique_key('rename_test', ARRAY['col2', 'col1', 'col3'], 'p');
NOTICE:  sql_saga: Added constraints to table rename_test: ADD CONSTRAINT rename_test_col2_col1_col3_p_uniq UNIQUE (col2, col1, col3, valid_range WITHOUT OVERLAPS)
        add_unique_key        
------------------------------
 rename_test_col2_col1_col3_p
(1 row)

TABLE sql_saga.unique_keys;
       unique_key_name        | table_schema | table_name  | key_type |   column_names   | era_name |         unique_constraint         | exclude_constraint | check_constraint | predicate | mutually_exclusive_columns | pk_consistency_constraint_names 
------------------------------+--------------+-------------+----------+------------------+----------+-----------------------------------+--------------------+------------------+-----------+----------------------------+---------------------------------
 rename_test_col2_col1_col3_p | public       | rename_test | natural  | {col2,col1,col3} | p        | rename_test_col2_col1_col3_p_uniq |                    |                  |           |                            | {}
(1 row)

ALTER TABLE rename_test RENAME COLUMN col1 TO "COLUMN1";
ALTER TABLE rename_test RENAME CONSTRAINT rename_test_col2_col1_col3_p_uniq TO unconst;
TABLE sql_saga.unique_keys;
       unique_key_name        | table_schema | table_name  | key_type |    column_names     | era_name | unique_constraint | exclude_constraint | check_constraint | predicate | mutually_exclusive_columns | pk_consistency_constraint_names 
------------------------------+--------------+-------------+----------+---------------------+----------+-------------------+--------------------+------------------+-----------+----------------------------+---------------------------------
 rename_test_col2_col1_col3_p | public       | rename_test | natural  | {col2,COLUMN1,col3} | p        | unconst           |                    |                  |           |                            | {}
(1 row)

/* foreign_keys */
CREATE TABLE rename_test_ref (LIKE rename_test);
SELECT sql_saga.add_era('rename_test_ref', 'valid_range', 'q', valid_from_column_name => 's < e', valid_until_column_name => 'embedded " symbols');
NOTICE:  sql_saga: Created trigger "rename_test_ref_synchronize_temporal_columns_trigger" on table rename_test_ref to synchronize columns: s < e, embedded " symbols
NOTICE:  sql_saga: Created GIST index "rename_test_ref_valid_range_gist_idx" on column public.rename_test_ref.valid_range for temporal_merge performance
 add_era 
---------
 t
(1 row)

TABLE sql_saga.era;
 table_schema |   table_name    | era_name | range_column_name | valid_from_column_name | valid_until_column_name | range_type | multirange_type | range_subtype | range_subtype_category | bounds_check_constraint | boundary_check_constraint | valid_to_column_name | trigger_applies_defaults |       sync_temporal_trg_name        |    sync_temporal_trg_function_name     | audit_schema_name | audit_table_name | ephemeral_columns 
--------------+-----------------+----------+-------------------+------------------------+-------------------------+------------+-----------------+---------------+------------------------+-------------------------+---------------------------+----------------------+--------------------------+-------------------------------------+----------------------------------------+-------------------+------------------+-------------------
 public       | rename_test     | p        | valid_range       | s < e                  | embedded " symbols      | int4range  | int4multirange  | integer       | N                      | start_before_end        | rename_test_check         |                      | t                        | rename_test_p_sync_temporal_trg     | public_rename_test_p_template_sync     |                   |                  | 
 public       | rename_test_ref | q        | valid_range       | s < e                  | embedded " symbols      | int4range  | int4multirange  | integer       | N                      | rename_test_ref_q_check | rename_test_ref_check     |                      | t                        | rename_test_ref_q_sync_temporal_trg | public_rename_test_ref_q_template_sync |                   |                  | 
(2 rows)

SELECT sql_saga.add_temporal_foreign_key('rename_test_ref', ARRAY['col2', 'COLUMN1', 'col3'], 'q', 'rename_test_col2_col1_col3_p');
NOTICE:  sql_saga: No compatible index found for foreign key on table rename_test_ref. Creating new index: CREATE INDEX "rename_test_ref_col2_COLUMN1_col3_q_gist_idx" ON rename_test_ref USING GIST (col2, "COLUMN1", col3, valid_range)
      add_temporal_foreign_key       
-------------------------------------
 rename_test_ref_col2_COLUMN1_col3_q
(1 row)

TABLE sql_saga.foreign_keys;
          foreign_key_name           |         type         | table_schema |   table_name    |    column_names     | fk_era_name |                   fk_table_columns_snapshot                   |       unique_key_name        | match_type | update_action | delete_action | fk_check_constraint | fk_helper_function | uk_update_trigger | uk_delete_trigger |                fk_index_name                 
-------------------------------------+----------------------+--------------+-----------------+---------------------+-------------+---------------------------------------------------------------+------------------------------+------------+---------------+---------------+---------------------+--------------------+-------------------+-------------------+----------------------------------------------
 rename_test_ref_col2_COLUMN1_col3_q | temporal_to_temporal | public       | rename_test_ref | {col2,COLUMN1,col3} | q           | {COLUMN1,col2,col3,valid_range,"s < e","embedded \" symbols"} | rename_test_col2_col1_col3_p | SIMPLE     | NO ACTION     | NO ACTION     |                     |                    |                   |                   | rename_test_ref_col2_COLUMN1_col3_q_gist_idx
(1 row)

SAVEPOINT pristine;
ALTER TABLE rename_test_ref RENAME COLUMN "COLUMN1" TO col1;
TABLE sql_saga.foreign_keys; -- The column name should be updated here
         foreign_key_name         |         type         | table_schema |   table_name    |   column_names   | fk_era_name |                 fk_table_columns_snapshot                  |       unique_key_name        | match_type | update_action | delete_action | fk_check_constraint | fk_helper_function |             uk_update_trigger              |             uk_delete_trigger              |                fk_index_name                 
----------------------------------+----------------------+--------------+-----------------+------------------+-------------+------------------------------------------------------------+------------------------------+------------+---------------+---------------+---------------------+--------------------+--------------------------------------------+--------------------------------------------+----------------------------------------------
 rename_test_ref_col2_col1_col3_q | temporal_to_temporal | public       | rename_test_ref | {col2,col1,col3} | q           | {col1,col2,col3,valid_range,"s < e","embedded \" symbols"} | rename_test_col2_col1_col3_p | SIMPLE     | NO ACTION     | NO ACTION     |                     |                    | rename_test_ref_col2_col1_col3_q_uk_update | rename_test_ref_col2_col1_col3_q_uk_delete | rename_test_ref_col2_COLUMN1_col3_q_gist_idx
(1 row)

ROLLBACK TO SAVEPOINT pristine;
/* Test protection of synchronize_temporal_columns_trigger */
ALTER TRIGGER rename_test_p_sync_temporal_trg ON rename_test RENAME TO my_trigger;
ERROR:  cannot drop or rename trigger "rename_test_p_sync_temporal_trg" on table "rename_test" because it is managed by era "p"
CONTEXT:  PL/pgSQL function rename_following() line 601 at RAISE
ROLLBACK TO SAVEPOINT pristine;
ALTER TRIGGER rename_test_ref_q_sync_temporal_trg ON rename_test_ref RENAME TO another_trigger;
ERROR:  cannot drop or rename trigger "rename_test_ref_q_sync_temporal_trg" on table "rename_test_ref" because it is managed by era "q"
CONTEXT:  PL/pgSQL function rename_following() line 601 at RAISE
ROLLBACK TO SAVEPOINT pristine;
TABLE sql_saga.foreign_keys;
          foreign_key_name           |         type         | table_schema |   table_name    |    column_names     | fk_era_name |                   fk_table_columns_snapshot                   |       unique_key_name        | match_type | update_action | delete_action | fk_check_constraint | fk_helper_function | uk_update_trigger | uk_delete_trigger |                fk_index_name                 
-------------------------------------+----------------------+--------------+-----------------+---------------------+-------------+---------------------------------------------------------------+------------------------------+------------+---------------+---------------+---------------------+--------------------+-------------------+-------------------+----------------------------------------------
 rename_test_ref_col2_COLUMN1_col3_q | temporal_to_temporal | public       | rename_test_ref | {col2,COLUMN1,col3} | q           | {COLUMN1,col2,col3,valid_range,"s < e","embedded \" symbols"} | rename_test_col2_col1_col3_p | SIMPLE     | NO ACTION     | NO ACTION     |                     |                    |                   |                   | rename_test_ref_col2_COLUMN1_col3_q_gist_idx
(1 row)

SELECT sql_saga.drop_foreign_key('rename_test_ref', ARRAY['col2', 'COLUMN1', 'col3'], 'q');
NOTICE:  sql_saga: Dropping automatically created index "rename_test_ref_col2_COLUMN1_col3_q_gist_idx" for foreign key "rename_test_ref_col2_COLUMN1_col3_q"
 drop_foreign_key 
------------------
 
(1 row)

SELECT sql_saga.drop_unique_key('rename_test', ARRAY['col2', 'COLUMN1', 'col3'], 'p');
 drop_unique_key 
-----------------
 
(1 row)

SELECT sql_saga.drop_era('rename_test', 'p');
 drop_era 
----------
 t
(1 row)

DROP TABLE rename_test;
SELECT sql_saga.drop_era('rename_test_ref','q');
 drop_era 
----------
 t
(1 row)

DROP TABLE rename_test_ref;
ROLLBACK;
\echo '\n--- System Versioning Rename Following Tests ---'

--- System Versioning Rename Following Tests ---
CREATE TABLE sv_rename_test (
    id serial PRIMARY KEY,
    data text
);
SELECT sql_saga.add_system_versioning('sv_rename_test');
 add_system_versioning 
-----------------------
 
(1 row)

-- Get current constraint/trigger names from metadata
\echo '--- Initial metadata ---'
--- Initial metadata ---
SELECT infinity_check_constraint, generated_always_trigger, write_history_trigger, truncate_trigger
FROM sql_saga.system_time_era
WHERE table_name = 'sv_rename_test';
            infinity_check_constraint             |          generated_always_trigger           |          write_history_trigger           |    truncate_trigger     
--------------------------------------------------+---------------------------------------------+------------------------------------------+-------------------------
 sv_rename_test_system_valid_range_infinity_check | sv_rename_test_system_time_generated_always | sv_rename_test_system_time_write_history | sv_rename_test_truncate
(1 row)

-- Rename the infinity check constraint
ALTER TABLE sv_rename_test RENAME CONSTRAINT sv_rename_test_system_valid_range_infinity_check TO sv_rename_test_inf_check_renamed;
\echo '--- After renaming infinity_check_constraint ---'
--- After renaming infinity_check_constraint ---
SELECT infinity_check_constraint
FROM sql_saga.system_time_era
WHERE table_name = 'sv_rename_test';
    infinity_check_constraint     
----------------------------------
 sv_rename_test_inf_check_renamed
(1 row)

-- Rename the generated_always trigger
ALTER TRIGGER sv_rename_test_system_time_generated_always ON sv_rename_test RENAME TO sv_rename_test_gen_always_renamed;
\echo '--- After renaming generated_always_trigger ---'
--- After renaming generated_always_trigger ---
SELECT generated_always_trigger
FROM sql_saga.system_time_era
WHERE table_name = 'sv_rename_test';
     generated_always_trigger      
-----------------------------------
 sv_rename_test_gen_always_renamed
(1 row)

-- Rename the write_history trigger
ALTER TRIGGER sv_rename_test_system_time_write_history ON sv_rename_test RENAME TO sv_rename_test_write_hist_renamed;
\echo '--- After renaming write_history_trigger ---'
--- After renaming write_history_trigger ---
SELECT write_history_trigger
FROM sql_saga.system_time_era
WHERE table_name = 'sv_rename_test';
       write_history_trigger       
-----------------------------------
 sv_rename_test_write_hist_renamed
(1 row)

-- Rename the truncate trigger
ALTER TRIGGER sv_rename_test_truncate ON sv_rename_test RENAME TO sv_rename_test_trunc_renamed;
\echo '--- After renaming truncate_trigger ---'
--- After renaming truncate_trigger ---
SELECT truncate_trigger
FROM sql_saga.system_time_era
WHERE table_name = 'sv_rename_test';
       truncate_trigger       
------------------------------
 sv_rename_test_trunc_renamed
(1 row)

-- Verify all renames tracked
\echo '--- Final metadata (all renamed) ---'
--- Final metadata (all renamed) ---
SELECT infinity_check_constraint, generated_always_trigger, write_history_trigger, truncate_trigger
FROM sql_saga.system_time_era
WHERE table_name = 'sv_rename_test';
    infinity_check_constraint     |     generated_always_trigger      |       write_history_trigger       |       truncate_trigger       
----------------------------------+-----------------------------------+-----------------------------------+------------------------------
 sv_rename_test_inf_check_renamed | sv_rename_test_gen_always_renamed | sv_rename_test_write_hist_renamed | sv_rename_test_trunc_renamed
(1 row)

-- Cleanup
SELECT sql_saga.drop_system_versioning('sv_rename_test');
 drop_system_versioning 
------------------------
 t
(1 row)

DROP TABLE sv_rename_test;
\i sql/include/test_teardown.sql
--
-- test_teardown.sql
--
-- Common teardown for regression tests. This script drops the unprivileged
-- user role created by test_setup.sql.
--
-- It is important to reset the role first, in case a test fails and
-- leaves the session role set to the user that is about to be dropped.
RESET ROLE;
-- Drop the extensions to ensure a clean state for the next test.
-- Use CASCADE to remove any dependent objects created by sql_saga.
DROP EXTENSION IF EXISTS sql_saga CASCADE;
DROP EXTENSION IF EXISTS btree_gist CASCADE;
-- Revoke any privileges held by the test user and drop any objects they own.
-- This is necessary before the role can be dropped.
DROP OWNED BY sql_saga_unprivileged_user;
DROP ROLE IF EXISTS sql_saga_unprivileged_user;
