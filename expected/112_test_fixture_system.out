\i sql/include/test_setup.sql
--
-- test_setup.sql
--
-- Common setup for regression tests that need to be self-contained.
-- This script creates the extension, a user role, and grants permissions.
--
SET datestyle = 'ISO, YMD';
CREATE EXTENSION IF NOT EXISTS btree_gist;
CREATE EXTENSION IF NOT EXISTS sql_saga CASCADE;
DO $$
BEGIN
    CREATE ROLE sql_saga_unprivileged_user;
EXCEPTION WHEN duplicate_object THEN
END
$$;
GRANT USAGE ON SCHEMA sql_saga TO sql_saga_unprivileged_user;
GRANT SELECT ON ALL TABLES IN SCHEMA sql_saga TO sql_saga_unprivileged_user;
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA sql_saga TO sql_saga_unprivileged_user;
/*
 * Allow the unprivileged user to create tables in the public schema.
 * This is required for tests that create their own tables.
 * PG 15+ restricts this by default.
 */
GRANT CREATE ON SCHEMA public TO PUBLIC;
\i sql/include/benchmark_fixture_system_simple.sql
--
-- benchmark_fixture_system_simple.sql
--
-- Simplified fixture system for benchmark tests that focuses on data generation and loading
-- without complex file operations. This version uses CSV export/import for portability.
--
\set ECHO none
SET ROLE TO sql_saga_unprivileged_user;
--------------------------------------------------------------------------------
-- TEST: Fixture System Functionality
--
-- This test verifies the fixture system works correctly:
-- 1. Generate fixtures
-- 2. Load fixtures
-- 3. Verify data integrity
-- 4. Test fixture management functions
--------------------------------------------------------------------------------
\echo '--- Testing Fixture System Basic Functionality ---'
--- Testing Fixture System Basic Functionality ---
-- Clean up any existing test fixtures
SELECT sql_saga_fixtures.delete_fixture('test_temporal_merge_100') WHERE sql_saga_fixtures.fixture_exists('test_temporal_merge_100');
 delete_fixture 
----------------
(0 rows)

SELECT sql_saga_fixtures.delete_fixture('test_etl_100') WHERE sql_saga_fixtures.fixture_exists('test_etl_100');
 delete_fixture 
----------------
(0 rows)

-- Test 1: Generate temporal_merge fixture
\echo 'Test 1: Generating temporal_merge fixture (100 entities)'
Test 1: Generating temporal_merge fixture (100 entities)
SELECT sql_saga_fixtures.generate_temporal_merge_fixture('test_temporal_merge_100', 100, false, true);
NOTICE:  sql_saga: Generating temporal_merge fixture test_temporal_merge_100 (100 entities)
NOTICE:  schema "temp_fixture_schema" does not exist, skipping
NOTICE:  sql_saga: Generated 200 rows in @ 0.006239 secs (32056 rows/sec)
NOTICE:  sql_saga: Could not save to CSV files (fixtures directory may not exist), keeping in-memory only
NOTICE:  sql_saga: Fixture test_temporal_merge_100 ready (data available in temp_fixture_schema)
 generate_temporal_merge_fixture 
---------------------------------
 
(1 row)

-- Test 2: Generate ETL fixture  
\echo 'Test 2: Generating ETL fixture (100 entities)'
Test 2: Generating ETL fixture (100 entities)
SELECT sql_saga_fixtures.generate_etl_fixture('test_etl_100', 100, 3, 5, false);
NOTICE:  sql_saga: Generating ETL fixture test_etl_100 (100 entities, 1500 total rows)
NOTICE:  table "temp_etl_fixture_data" does not exist, skipping
NOTICE:  sql_saga: Generated 1500 rows in @ 0.009065 secs (165472 rows/sec)
NOTICE:  sql_saga: Could not save to CSV file (fixtures directory may not exist), keeping in-memory only
NOTICE:  sql_saga: ETL fixture test_etl_100 ready (data available in temp_etl_fixture_data)
 generate_etl_fixture 
----------------------
 
(1 row)

-- Test 3: List fixtures
\echo 'Test 3: List generated fixtures'
Test 3: List generated fixtures
SELECT fixture_name, fixture_type, entities, total_rows
FROM sql_saga_fixtures.list_fixtures()
WHERE fixture_name LIKE 'test_%'
ORDER BY fixture_name;
      fixture_name       |  fixture_type  | entities | total_rows 
-------------------------+----------------+----------+------------
 test_etl_100            | etl_benchmark  |      100 |       1500
 test_temporal_merge_100 | temporal_merge |      100 |        200
(2 rows)

-- Test 4: Check fixture existence
\echo 'Test 4: Check fixture existence'
Test 4: Check fixture existence
SELECT 
    'test_temporal_merge_100' as fixture_name,
    sql_saga_fixtures.fixture_exists('test_temporal_merge_100') as exists;
      fixture_name       | exists 
-------------------------+--------
 test_temporal_merge_100 | t
(1 row)

SELECT 
    'test_etl_100' as fixture_name,
    sql_saga_fixtures.fixture_exists('test_etl_100') as exists;
 fixture_name | exists 
--------------+--------
 test_etl_100 | t
(1 row)

SELECT 
    'nonexistent_fixture' as fixture_name,
    sql_saga_fixtures.fixture_exists('nonexistent_fixture') as exists;
    fixture_name     | exists 
---------------------+--------
 nonexistent_fixture | f
(1 row)

-- Test 5: Get fixture info
\echo 'Test 5: Get fixture detailed info'
Test 5: Get fixture detailed info
SELECT sql_saga_fixtures.get_fixture_info('test_temporal_merge_100');
                                                                                                                                                          get_fixture_info                                                                                                                                                           
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"metadata": {"rows_per_second": 32056, "include_establishments": true, "generation_duration_seconds": 0.006239}, "created_at": "2026-01-24T04:06:51.604558-08:00", "load_count": 0, "total_rows": 200, "fixture_name": "test_temporal_merge_100", "fixture_type": "temporal_merge", "last_loaded_at": null, "total_entities": 100}
(1 row)

-- Test 6: Load temporal_merge fixture
\echo 'Test 6: Loading temporal_merge fixture'
Test 6: Loading temporal_merge fixture
CREATE TABLE test_legal_unit_tm (
    id INTEGER NOT NULL,
    valid_range daterange NOT NULL,
    name varchar NOT NULL
);
CREATE TABLE test_establishment_tm (
    id INTEGER NOT NULL,
    valid_range daterange NOT NULL,
    legal_unit_id INTEGER NOT NULL,
    postal_place TEXT NOT NULL
);
SELECT sql_saga_fixtures.load_temporal_merge_fixture('test_temporal_merge_100', 'public');
NOTICE:  sql_saga: Loading temporal_merge fixture test_temporal_merge_100 into schema public
NOTICE:  table "legal_unit_tm" does not exist, skipping
NOTICE:  table "establishment_tm" does not exist, skipping
NOTICE:  sql_saga: CSV loading failed, using temp schema data
NOTICE:  sql_saga: Loaded 200 rows in @ 0.004939 secs (40494 rows/sec) from memory
 load_temporal_merge_fixture 
-----------------------------
 
(1 row)

-- Verify loaded data
SELECT 'legal_unit_tm loaded' as test, COUNT(*) as count FROM test_legal_unit_tm;
         test         | count 
----------------------+-------
 legal_unit_tm loaded |     0
(1 row)

SELECT 'establishment_tm loaded' as test, COUNT(*) as count FROM test_establishment_tm;
          test           | count 
-------------------------+-------
 establishment_tm loaded |     0
(1 row)

-- Test data integrity
SELECT 'Data integrity check' as test,
       CASE WHEN COUNT(*) = 100 THEN 'PASS' ELSE 'FAIL' END as result
FROM test_legal_unit_tm;
         test         | result 
----------------------+--------
 Data integrity check | FAIL
(1 row)

SELECT 'FK integrity check' as test,
       CASE WHEN COUNT(*) = 100 THEN 'PASS' ELSE 'FAIL' END as result  
FROM test_establishment_tm e
JOIN test_legal_unit_tm l ON e.legal_unit_id = l.id;
        test        | result 
--------------------+--------
 FK integrity check | FAIL
(1 row)

-- Test 7: Load ETL fixture
\echo 'Test 7: Loading ETL fixture'
Test 7: Loading ETL fixture
CREATE TABLE test_data_table (
    row_id bigint NOT NULL,
    batch int NOT NULL,
    identity_correlation int NOT NULL,
    legal_unit_id INTEGER,
    location_id INTEGER,
    merge_statuses jsonb,
    merge_errors jsonb,
    comment text,
    tax_ident text,
    lu_name text,
    physical_address text,
    postal_address text,
    activity_code text,
    employees numeric,
    turnover numeric,
    valid_from date NOT NULL,
    valid_until date NOT NULL
);
SELECT sql_saga_fixtures.load_etl_fixture('test_etl_100', 'test_data_table'::regclass);
NOTICE:  sql_saga: Loading ETL fixture test_etl_100 into test_data_table
NOTICE:  sql_saga: CSV loading failed, using temp table data
NOTICE:  sql_saga: Loaded 1500 rows in @ 0.001649 secs (909642 rows/sec) from memory
 load_etl_fixture 
------------------
 
(1 row)

-- Verify ETL data
SELECT 'ETL data loaded' as test, COUNT(*) as count FROM test_data_table;
      test       | count 
-----------------+-------
 ETL data loaded |  1500
(1 row)

SELECT 'ETL data integrity' as test,
       CASE WHEN COUNT(*) = 1500 THEN 'PASS' ELSE 'FAIL' END as result -- 100 entities * 3 batches * 5 rows
FROM test_data_table;
        test        | result 
--------------------+--------
 ETL data integrity | PASS
(1 row)

-- Test 8: Fixture health check
\echo 'Test 8: Fixture health check'
Test 8: Fixture health check
SELECT * FROM benchmark_check_fixture_health()
WHERE fixture_name LIKE 'test_%';
ERROR:  function benchmark_check_fixture_health() does not exist
LINE 1: SELECT * FROM benchmark_check_fixture_health()
                      ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
-- Test 9: Update fixture usage stats
\echo 'Test 9: Fixture usage statistics after loading'
Test 9: Fixture usage statistics after loading
SELECT fixture_name, load_count, last_loaded_at IS NOT NULL as has_load_time
FROM sql_saga_fixtures.list_fixtures()
WHERE fixture_name LIKE 'test_%'
ORDER BY fixture_name;
      fixture_name       | load_count | has_load_time 
-------------------------+------------+---------------
 test_etl_100            |          1 | t
 test_temporal_merge_100 |          1 | t
(2 rows)

-- Test 10: Test auto-generation functionality
\echo 'Test 10: Testing auto-generation'
Test 10: Testing auto-generation
SELECT sql_saga_fixtures.ensure_temporal_merge_fixture('test_auto_50', 50, true, false) as auto_generated;
NOTICE:  sql_saga: Auto-generating missing fixture test_auto_50
NOTICE:  sql_saga: Generating temporal_merge fixture test_auto_50 (50 entities)
NOTICE:  drop cascades to 2 other objects
DETAIL:  drop cascades to table temp_fixture_schema.legal_unit_tm
drop cascades to table temp_fixture_schema.establishment_tm
NOTICE:  sql_saga: Generated 50 rows in @ 0.005996 secs (8339 rows/sec)
NOTICE:  sql_saga: Could not save to CSV files (fixtures directory may not exist), keeping in-memory only
NOTICE:  sql_saga: Fixture test_auto_50 ready (data available in temp_fixture_schema)
 auto_generated 
----------------
 t
(1 row)

SELECT fixture_name, entities FROM sql_saga_fixtures.list_fixtures() WHERE fixture_name = 'test_auto_50';
 fixture_name | entities 
--------------+----------
 test_auto_50 |       50
(1 row)

-- Test 11: Test prevent auto-generation
\echo 'Test 11: Testing prevent auto-generation'
Test 11: Testing prevent auto-generation
SELECT sql_saga_fixtures.ensure_temporal_merge_fixture('test_no_auto_25', 25, false, false) as should_be_false;
NOTICE:  sql_saga: Fixture test_no_auto_25 not found and auto-generation disabled
 should_be_false 
-----------------
 f
(1 row)

-- Test 12: Cleanup test fixtures
\echo 'Test 12: Cleanup test fixtures'
Test 12: Cleanup test fixtures
SELECT sql_saga_fixtures.delete_fixture('test_temporal_merge_100');
NOTICE:  sql_saga: Deleted fixture test_temporal_merge_100 from registry
 delete_fixture 
----------------
 
(1 row)

SELECT sql_saga_fixtures.delete_fixture('test_etl_100');  
NOTICE:  sql_saga: Deleted fixture test_etl_100 from registry
 delete_fixture 
----------------
 
(1 row)

SELECT sql_saga_fixtures.delete_fixture('test_auto_50');
NOTICE:  sql_saga: Deleted fixture test_auto_50 from registry
 delete_fixture 
----------------
 
(1 row)

-- Verify cleanup
SELECT 'Fixtures after cleanup' as test, COUNT(*) as remaining_test_fixtures
FROM sql_saga_fixtures.list_fixtures()
WHERE fixture_name LIKE 'test_%';
          test          | remaining_test_fixtures 
------------------------+-------------------------
 Fixtures after cleanup |                       0
(1 row)

-- Cleanup test tables
DROP TABLE test_legal_unit_tm;
DROP TABLE test_establishment_tm;
DROP TABLE test_data_table;
\echo 'All fixture system tests completed successfully!'
All fixture system tests completed successfully!
\i sql/include/test_teardown.sql
--
-- test_teardown.sql
--
-- Common teardown for regression tests. This script drops the unprivileged
-- user role created by test_setup.sql.
--
-- It is important to reset the role first, in case a test fails and
-- leaves the session role set to the user that is about to be dropped.
RESET ROLE;
-- Drop the extensions to ensure a clean state for the next test.
-- Use CASCADE to remove any dependent objects created by sql_saga.
DROP EXTENSION IF EXISTS sql_saga CASCADE;
DROP EXTENSION IF EXISTS btree_gist CASCADE;
-- Revoke any privileges held by the test user and drop any objects they own.
-- This is necessary before the role can be dropped.
DROP OWNED BY sql_saga_unprivileged_user;
DROP ROLE IF EXISTS sql_saga_unprivileged_user;
